# SapMachine - Repositories and Build Infrastructure

1. SapMachine Github Repository https://github.com/SAP/SapMachine
    * Mercurial repos are imported to branches jdk/jdk and jdk/jdk10.
        * We look every 3 h and add new changes and tags from the mercurial repository.
        * On jenkins: *update-pipeline* https://sapmachine-ci.sapcloud.io/view/repository-update/job/update-pipeline/.
    * sapmachine10: jdk/jdk10 + our changes.
    * sapmachine: jdk/jdk + our changes.
    * sapmachine10-alpine: sapmachine10 + alpine changes.
    * sapmachine-alpine: sapmachine + alpine changes.
    * We cherry-pick our changes between sapmachine and sapmachine10
    * We merge jdk/jdk10 and jdk/jdk with new build tags.
        * Jenkins look for new tags, open pull request and validate.
        * Check for new tags: *check-tag-pipeline* 
            * Triggered by *update-pipeline*
        * Merge is triggered manually (Push the button on github).

2. Build-Jobs
    * We use Pipeline defintions for our build jobs checked-in in http://github.com/SAP/SapMachine-infrastructure.
    * Build-jobs run in docker containers to have a reproducible build envrironment.
    * Different build-jobs use the same Pipeline with different parameters.
    * Build jobs start test jobs. However, we don't use the result of the tests as indicator of a failure of the build job. Mostly, there are errors in the openjdk
    http://download.java.net/openjdk/testresults/10
    * Builds and tests of codelines are grouped by views. So it is easy to find the correspondig tests to a build.
    * We backup the jenkins configuration to github.
    
    
3. Linux Packages
    
    We provide Linux Packages for Debian based distributions and Alpine Linux.
    * For Debian / Ubuntu, you need to install the SapMachine public key into the apt key store.
        ```
        wget -q -O - https://sapmachine-ubuntu.sapcloud.io/debian/sapmachine-debian.key | apt-key add -
        ```
        Add the SapMachine Debian package repository the the apt sources list and do an ```apt-get update```.
    	```
		echo "deb http://sapmachine-ubuntu.sapcloud.io/debian/amd64/ ./" >> /etc/apt/sources.list
        apt-get update
        ```
        Now you can install the SapMachine JRE and/or SapMachine JDK.
        ```
		apt-get install sapmachine-10-jre
        apt-get install sapmachine-10-jdk
        ```
        It is also possibe to install a specific version by:
        ```
        apt-get install sapmachine-10-jre=10+39-1
        ```
    * For Alpine Linux, you need to download and save the SapMachine public key into the APK key location.
        ```
        cd /etc/apk/keys
        wget https://sapmachine-ubuntu.sapcloud.io/alpine/sapmachine%40sap.com-5a673212.rsa.pub
        ```
        Add the SapMachine APK package repository to the APK repository list and do an ```apk update```.
        ```
        echo "http://sapmachine-ubuntu.sapcloud.io/alpine" >> /etc/apk/repositories
        apk update
        ```
        Now you can install the SapMachine JRE and/or SapMachine JDK.
        ```
        apk add sapmachine-10-jdk
        apk add sapmachine-10-jre
        ```
        It is also possibe to install a specific version by:
        ```
        apk add sapmachine-10-jre=10.39.1-r0
        ```

    * Generated by Jenkins jobs
    
	The Linux Packages are built by SapMachine Jenkins Jobs.

        * https://sapmachine-ci.sapcloud.io/view/package/job/apk-pipeline/
        * https://sapmachine-ci.sapcloud.io/view/package/job/debian-pipeline/
	
    Both jobs are able to build the Linux Packages for a given Git Tag and deploy them to the SapMachine Linux Package server.

3. Docker
    * Generate Dockerfiles and check-in Dockerfile for new versions.
    * Run jtreg tests in Docker images build from the dockerfiles.
    * Build and push images to https://hub.docker.com/r/sapmachine/.
    * Jenkins: https://sapmachine-ci.sapcloud.io/view/docker/job/build-10-docker/.

